---
- hosts: all
  become: true
  tasks:
  - name: add the ondrej PHP PPA
    apt_repository: repo='ppa:ondrej/php'
  - name: update the apt cache
    apt: update_cache=yes cache_valid_time=3600
  - name: Install latest PHP
    apt: name={{item}} state=installed
    with_items:
      - php
      - php-fpm
      - php-mysql
      - php-xml
  - name: Remove apache2
    apt: name=apache2 state=removed
  - name: Install MySQL
    apt: name={{item}} state=installed
    with_items:
      - mysql-server-5.6
      - python-mysqldb
  - name: Generate new root password
    command: openssl rand -hex 7 creates=/root/.my.cnf
    register: mysql_new_root_pass
  - name: Remove anonymous users
    mysql_user: name="" state=absent
    when: mysql_new_root_pass.changed
  - name: Remove test database
    mysql_db: name=test state=absent
    when: mysql_new_root_pass.changed
  - name: Update root password
    mysql_user: name=root host={{item}} password={{mysql_new_root_pass.stdout}}
    with_items:
      - "{{ ansible_hostname }}"
      - 127.0.0.1
      - ::1
      - localhost
    when: mysql_new_root_pass.changed
  - name: Output new root password
    debug: msg="New root password is {{mysql_new_root_pass.stdout}}"
    when: mysql_new_root_pass.changed
  - debug: msg="No change to root password"
    when: not mysql_new_root_pass.changed
  - name: Create my.cnf
    template: src=templates/mysql/my.cnf dest=/root/.my.cnf
    when: mysql_new_root_pass.changed
  - name: Install nginx
    apt: name=nginx state=installed
  - name: Start nginx
    service: name=nginx state=running
  - name: Create nginx config
    template: src=templates/nginx/default dest=/etc/nginx/sites-available/default
    notify: restart nginx
  handlers:
  - name: restart nginx
    service: name=nginx state=restarted

